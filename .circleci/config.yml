version: 2
jobs:
  build:
    docker:
      - image: davidde94/inertia:1.0.1
    working_directory: /Inertia
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "0a:12:a4:a4:89:6f:eb:f7:13:01:4d:85:f0:52:ac:cb"
      - run:
          name: Setup
          command: |
              ldconfig -v
              echo 'export PATH="$PATH:/usr/local/bin/swift/usr/bin"' >> $BASH_ENV
              source $BASH_ENV
      - run:
          name: Deploy if needed
          command: |
              ls ~/.ssh
              if [ "${CIRCLE_BRANCH}" != "master" ]; then
                echo "Not master, not deploying"
                exit 0
              fi

              ssh -i ~/.ssh/id_rsa_0a12a4a4896febf713014d85f052accb -o StrictHostKeyChecking=no -p 14815 app-banterurl@main.blackpoint.co "cd BanterURL && git fetch --all && git reset --hard origin/master && /usr/local/bin/swift/usr/bin/swift package update && /usr/local/bin/swift/usr/bin/swift build -c release && sudo service banterurl restart"
